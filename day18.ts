const input = `[[1,[8,[5,8]]],[[4,4],[8,[8,8]]]]
[[[3,[2,3]],[[8,0],2]],[0,[[8,1],[7,0]]]]
[4,[[0,3],[[6,6],[3,8]]]]
[[[7,[6,4]],[[0,6],[2,0]]],[[[5,6],[0,4]],[[8,1],[9,1]]]]
[[[6,3],[[6,9],4]],[[1,[4,2]],[[0,0],1]]]
[[2,0],[3,[0,8]]]
[[0,[5,5]],[[4,2],[3,[6,4]]]]
[[[[9,9],[8,5]],[7,4]],[[6,9],[8,[0,8]]]]
[[[[7,1],[2,9]],[[9,3],0]],[3,[[0,6],[7,6]]]]
[[[[3,7],[7,1]],[[5,8],[0,1]]],3]
[[[[4,6],[6,2]],[[9,1],7]],[[9,1],[8,0]]]
[[[[2,7],0],[[9,4],[2,6]]],[0,[[7,4],[0,3]]]]
[[5,[[0,2],[8,8]]],[[[4,1],9],3]]
[[[7,1],[[3,7],[3,4]]],[[[0,7],[1,6]],1]]
[[[6,5],[[1,8],[8,8]]],[[4,5],[3,7]]]
[[[1,[3,3]],[[3,2],[5,7]]],[[8,[9,3]],[[5,3],4]]]
[[[4,[2,7]],9],[9,[[5,6],4]]]
[[[9,1],3],[[1,2],9]]
[[[[0,0],[2,3]],[[7,8],[1,5]]],[[[8,6],7],[[8,3],9]]]
[6,[[5,[0,8]],1]]
[4,[[[3,0],[2,0]],[[7,2],[1,4]]]]
[[[[4,3],[4,1]],8],[[[9,4],[1,9]],[4,[0,6]]]]
[4,[5,6]]
[[[0,[6,1]],[[6,1],3]],[[0,[7,8]],[1,0]]]
[[5,[[8,7],8]],8]
[[5,[[5,2],0]],[[1,[4,7]],[[0,9],[2,3]]]]
[[7,[2,2]],[[6,3],[5,8]]]
[[[0,9],5],[1,[[5,7],1]]]
[[8,[3,[0,3]]],[[[2,2],2],[[8,8],[8,9]]]]
[[6,[[3,2],[2,6]]],[5,1]]
[[[[9,8],[6,8]],[0,7]],7]
[[[7,2],[[6,3],4]],2]
[[[5,2],[[1,6],[8,3]]],[6,5]]
[[5,2],[0,5]]
[[[[4,5],5],[[4,6],[1,2]]],[[[3,6],[4,9]],[1,9]]]
[[1,[4,1]],[[9,[5,5]],[[9,0],[5,7]]]]
[[[[8,9],[7,7]],2],[8,1]]
[[[8,1],[8,[9,5]]],3]
[[[2,[3,9]],[[5,4],[7,9]]],[9,8]]
[8,[[2,[0,9]],[[5,0],4]]]
[[[6,[4,8]],[0,6]],[[8,[1,8]],1]]
[[6,[[1,0],[6,2]]],[[9,[3,7]],[5,[4,0]]]]
[[8,[0,[9,1]]],8]
[7,[4,[7,2]]]
[[1,[[5,7],[5,4]]],[[5,[8,0]],[1,6]]]
[[[[0,6],[6,2]],3],[[[9,3],7],[7,[1,2]]]]
[[[6,[4,9]],8],[6,5]]
[[[0,[1,9]],[[1,9],[3,9]]],[[[3,4],[7,5]],3]]
[[[[9,3],5],[[0,5],[2,7]]],9]
[[[6,[7,5]],5],[1,[[7,0],[3,4]]]]
[[[2,1],[[1,3],[1,5]]],[4,[9,[7,9]]]]
[[[[7,9],4],[[8,8],7]],[[[3,5],2],[[4,4],[6,5]]]]
[[1,1],[1,1]]
[[8,[0,2]],8]
[[[2,[2,1]],[[1,7],[1,2]]],[[1,6],5]]
[6,[0,[[1,0],[0,9]]]]
[6,[[2,[8,0]],[8,[8,8]]]]
[4,[[3,[0,3]],4]]
[[[5,3],3],[[0,[7,6]],[2,[5,8]]]]
[[[[8,1],[4,1]],[[5,8],[4,8]]],[[[1,7],[7,2]],[0,[2,7]]]]
[[[2,[3,5]],3],5]
[[7,[[9,5],[8,2]]],[[[1,8],8],5]]
[[3,5],[[4,[9,3]],5]]
[[[[4,6],2],[2,2]],[0,[0,4]]]
[[[[5,8],[6,6]],[2,0]],[[[2,3],9],[[4,5],2]]]
[[[[1,9],3],[[3,4],6]],[[3,6],[6,[0,7]]]]
[[[0,[5,5]],[2,6]],[[[7,4],4],2]]
[0,[[8,[6,2]],[5,[1,5]]]]
[[[[5,5],[9,6]],[[5,2],2]],[[4,7],[[5,5],[1,6]]]]
[[4,7],[[[1,8],[9,6]],[2,3]]]
[5,[5,4]]
[[[[2,1],[7,0]],[5,[7,8]]],[6,[3,1]]]
[[[3,1],[[2,4],6]],[[[1,8],[2,1]],[[1,7],4]]]
[[[5,[3,3]],6],[[[0,0],9],[1,[7,4]]]]
[[[6,5],[[7,3],4]],[[9,[0,3]],[3,[6,0]]]]
[[[3,4],7],[8,[[1,7],[9,9]]]]
[[[[2,1],6],[2,6]],[[[8,1],[6,2]],[9,0]]]
[[8,4],[5,2]]
[[4,[[4,5],9]],[[3,[5,2]],[4,2]]]
[[[8,8],[[8,0],[5,3]]],4]
[[1,8],[0,2]]
[[[[7,2],[9,0]],[[9,2],[1,2]]],[[[4,0],3],0]]
[[[[1,2],[1,8]],[[4,3],[8,6]]],[[[5,1],8],[8,1]]]
[[[[5,3],[7,2]],7],[[6,[7,9]],[[3,8],[9,4]]]]
[[[[3,1],[2,5]],6],[[[3,2],[8,8]],[4,6]]]
[9,[[3,[2,3]],6]]
[[[[4,0],[5,6]],[5,4]],[[[9,0],[1,8]],[5,[3,6]]]]
[[[[9,5],[9,4]],[[5,7],5]],[[[1,4],7],[6,1]]]
[[2,[6,[8,2]]],[7,[1,[3,3]]]]
[[[9,1],[0,[6,3]]],[[5,[1,5]],[7,[1,0]]]]
[1,6]
[[0,[2,[8,9]]],[[[4,5],[5,4]],1]]
[[[1,[4,1]],8],[[2,[7,0]],[7,[9,9]]]]
[[[[5,7],[3,5]],[[6,6],2]],[2,[8,[9,0]]]]
[6,[[[3,9],8],[[4,3],[6,1]]]]
[[[[6,7],[7,6]],[2,8]],[[9,[4,1]],6]]
[[[[4,5],[4,5]],[[0,6],5]],[[[6,5],[7,0]],1]]
[[[[6,7],9],[[5,5],[6,6]]],[[7,1],[[8,2],[3,1]]]]
[[[9,6],7],[[[1,8],8],[1,7]]]
[[5,2],[[1,9],[2,2]]]`;

const inputEx = `[[[0,[4,5]],[0,0]],[[[4,5],[2,6]],[9,5]]]
[7,[[[3,7],[4,3]],[[6,3],[8,8]]]]
[[2,[[0,8],[3,4]]],[[[6,7],1],[7,[1,6]]]]
[[[[2,4],7],[6,[0,5]]],[[[6,8],[2,8]],[[2,1],[4,5]]]]
[7,[5,[[3,8],[1,4]]]]
[[2,[2,2]],[8,[8,1]]]
[2,9]
[1,[[[9,3],9],[[9,0],[0,7]]]]
[[[5,[7,4]],7],1]
[[[[4,2],2],6],[8,7]]`;

class SFPair {
    constructor(public left: number | SFPair, public right: number | SFPair, public parent: SFPair | undefined) {
        if (typeof this.left !== 'number') {
            this.left.parent = this;
        }
        if (typeof this.right !== 'number') {
            this.right.parent = this;
        }
    }

    toString(): string {
        return '[' + this.left.toString() + ',' + this.right.toString() + ']';
    }

    magnitude(): number {
        return 3 * (typeof this.left === 'number' ? this.left : this.left.magnitude()) + 
            2 * (typeof this.right === 'number' ? this.right : this.right.magnitude());
    }

    add(other: SFPair): SFPair {
        const pair = new SFPair(this, other, undefined);
        pair.reduce();
        return pair;
    }

    reduce() {
        while (true) {
            // If any pair is nested inside four pairs, the leftmost such pair explodes.
            const fiveDeep = this._findFiveDeep();
            if (fiveDeep !== undefined) {
                console.log('exploding: ' + fiveDeep);
                fiveDeep.explode();
                continue;
            }

            // If any regular number is 10 or greater, the leftmost such regular number splits.
            if (this._findAndSplitBigNumber()) {
                console.log('splitting');
                continue;
            }

            return;
        }
    }

    // returns true for right, false for left
    getNextLeftNumPair(): [SFPair, boolean] | undefined {
        let pair: SFPair | undefined = this;
        while (pair && pair.parent) {
            if (pair.parent.right === pair) {
                if (typeof pair.parent.left === 'number') {
                    return [pair.parent, false];
                }
                let inner = pair.parent.left;
                while (true) {
                    if (typeof inner.right === 'number') {
                        return [inner, true];
                    }
                    inner = inner.right;
                }
            }
            pair = pair.parent;
        }
        return undefined;
    }

    getNextRightNumPair(): [SFPair, boolean] | undefined {
        let pair: SFPair | undefined = this;
        while (pair && pair.parent) {
            if (pair.parent.left === pair) {
                if (typeof pair.parent.right === 'number') {
                    return [pair.parent, true];
                }
                let inner = pair.parent.right;
                while (true) {
                    if (typeof inner.left === 'number') {
                        return [inner, false];
                    }
                    inner = inner.left;
                }
            }
            pair = pair.parent;
        }
        return undefined;
    }

    explode() {
        if (!this.parent) {
            throw 'no parent in explode';
        }
        if (typeof this.left !== 'number' || typeof this.right !== 'number') {
            throw 'bad type in explode';
        }

        const leftPair = this.getNextLeftNumPair();
        if (leftPair) {
            if (leftPair[1]) {
                (leftPair[0].right as number) += this.left;
            } else {
                (leftPair[0].left as number) += this.left;
            }
        }

        const rightPair = this.getNextRightNumPair();
        if (rightPair) {
            if (rightPair[1]) {
                (rightPair[0].right as number) += this.right;
            } else {
                (rightPair[0].left as number) += this.right;
            }
        }

        if (this.parent.left === this) {
            this.parent.left = 0;
        } else if (this.parent.right === this) {
            this.parent.right = 0;
        } else {
            throw 'no parent found';
        }
    }

    private _findFiveDeep(depth = 0): SFPair | undefined {
        if (depth === 4) {
            return this;
        }
        if (typeof this.left !== 'number') {
            const ret = this.left._findFiveDeep(depth + 1);
            if (ret) {
                return ret;
            }
        }
        if (typeof this.right !== 'number') {
            const ret = this.right._findFiveDeep(depth + 1);
            if (ret) {
                return ret;
            }
        }
        return undefined;
    }

    private _findAndSplitBigNumber(): boolean {
        if (typeof this.left !== 'number') {
            const ret = this.left._findAndSplitBigNumber();
            if (ret) {
                return true;
            }
        } else if (this.left >= 10) {
            this.left = new SFPair(Math.floor(this.left / 2), Math.ceil(this.left / 2), this);
            return true;
        }

        if (typeof this.right !== 'number') {
            const ret = this.right._findAndSplitBigNumber();
            if (ret) {
                return true;
            }
        } else if (this.right >= 10) {
            this.right = new SFPair(Math.floor(this.right / 2), Math.ceil(this.right / 2), this);
            return true;
        }

        return false;
    }

    static parseTerm(inp: string): SFPair | number {
        if (Number(inp).toString() === inp) {
            return Number(inp);
        } else {
            return SFPair.parse(inp);
        }
    }

    static parse(inp: string): SFPair {
        if (inp.substring(0,1) !== '[' || inp.substring(inp.length-1) !== ']') {
            throw 'Bad input: ' + inp;
        }

        let depth = 0;
        let segStart = -1;
        let left: number | SFPair | undefined;
        let right: number | SFPair | undefined;
        for (let i=0; i<inp.length; i++) {
            const char = inp.charAt(i);
            if (char === '[') {
                depth++;

                if (depth === 1) {
                    segStart = i + 1;
                }
            } else if (char === ']') {
                depth--;

                if (depth === 0) {
                    if (i !== inp.length - 1) {
                        throw 'end bad: ' + char;
                    }
                    right = SFPair.parseTerm(inp.substring(segStart, i));
                }
            } else if (depth === 1) {
                if (char === ',') {
                    if (segStart === -1) {
                        throw 'left1';
                    }
                    left = SFPair.parseTerm(inp.substring(segStart, i));
                    segStart = i + 1;
                }
            }
        }

        if (left === undefined || right === undefined) {
            throw 'no parsing: ' + inp + ' - ' + left + ', ' + right;
        }
        
        return new SFPair(left, right, undefined);
    }
}

// const ex1 = SFPair.parse(`[[[[4,3],4],4],[7,[[8,4],9]]]`).add(SFPair.parse(`[1,1]`));
// // ex1.reduce();
// console.log(ex1.toString());


const rows = input.split('\n').map(SFPair.parse);
let total = rows[0];
for (let i=1; i<rows.length; i++) {
    total = total.add(rows[i]);
}

console.log(total.toString());
console.log(total.magnitude());

// console.log(rows);